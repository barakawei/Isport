-content_for :head do
  = include_stylesheets :special_pages_events_comments, :media => 'all'

- if comments.size > 0
  -comments.each_with_index do |comment, index|
    .comment_block{:class => ('first' if index==0), :comment_id => comment.id}
      .comment_top
        .author_box
          = person_image_link(current_person)
        .author_text
          = link_to current_person.name, person_path(current_person), :class => 'author_name'
      .comment_text
        %span.content=simple_format comment.content
        %a{:class => 'editIconWrapper right'}
          %span.editIcon='删除'
      .comment_bottom
        = link_to '回复', '#', :class => 'response_link'
        %span.right.comment_time
          %em=l(comment.created_at, :format => :long)
    -comment.responses.each do |res|
      .response_box{:comment_id => comment.id}
        - rperson = res.person
        = person_image_link(rperson) 
        .res_text
          .res_text_inner
            .res_text_frame
              %span.res_operation.right=link_to '回复', '#', :class => 'response_link'
              %span.res_time=l(res.created_at, :format => :long)
              %storng.res_author=rperson.name
              .res_content
                %span=res.content

.pagination_box
  - if comments.size > 0
    = will_paginate comments, {:previous_label => t("pagination.previous"),
                               :next_label => t("pagination.next")}


.span-16.prepend-top
  = render 'common/header_box', :title => '发表评论'
  .new_comment
    = form_for comment, :url => event_event_comments_path(event.id), do |c|
      = person_image_link(current_person)
      .content
        = c.text_area :content
        = submit_tag '确定', :class => 'post_button'


.response_form.hide
  .response_box
    = person_image_link(current_person) 
    .res_text
      .res_text_inner
        .res_text_frame
          %p.res_author=current_person.name
          =form_tag event_event_comments_path(event.id) do
            = text_area_tag "comment[content]"
            = hidden_field_tag "comment[commentable_id]"
            = link_to '取消', '#', :class => "button cancel"
            = submit_tag '回复', :class => 'button submit'
          

        
:javascript
  $(function(){
    var options = {success: appendToComments, resetForm:true};
    $('#new_event_comment').ajaxForm(options);
  });
  
  $('.response_link').click(function() {
    $(this).hide();
    responseClick($(this));  
    return false;
  });

  function responseClick(link) {
    var block=null;
    if (link.parents('.response_box').size > 0) {
      block = link.parents('.response_box')
    } else {
      block = link.parents('.comment_block')
    }
    var $res_form = block.next('.response_form');
    if ($res_form.size > 0) {
      $res_form = slideDown();
    } else {
      cloneResponseForm(block, link); 
    }
  }

  function cloneResponseForm(block, link) {
    var response_form = $('.response_form:last').clone();
    block.after(response_form);

    var options = {success: appendToResponses, resetForm: true};
    response_form.find('form').ajaxForm(options);
    response_form.find('#comment_commentable_id').val(block.attr('comment_id')); 
    response_form.slideDown('fast', function() {
      response_form.find('textarea')
                   .val('回复'+ block.find('a.author_name').html() + ":")
                   .end().find('a.cancel').click(function() {
                      link.show();
                      response_form.slideUp();                   
                      return false;
                   });
    });
  }
  
  function appendToResponses(responseText, statusText, xhr, $form){
    var $parent = $form.parents('.response_form').prev('.comment_block');
    $form.parents('.response_form').hide();
    var c_id = $parent.attr('comment_id');
    $res = $(responseText);
    $('[comment_id="'+ c_id +'"]:last').after($res);
    $res.fadeIn('slow', function(){
        $parent.find('a.response_link').show();
    });
    jQuery("html,body").animate({scrollTop: $res.offset().top-200}, 0); 
  }
      
  function appendToComments(responseText, statusText, xhr, $form){
    $comment = $(responseText);
    $('.pagination_box').before($comment);
    $('.comment_block:first').addClass('first');
    $comment.fadeIn();
    return false;
  }


  
